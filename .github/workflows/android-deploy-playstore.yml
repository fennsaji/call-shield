name: Deploy Android to Play Store (Internal Testing)

on:
  push:
    branches: [main]
    paths:
      - 'android/**'
      - '.github/workflows/android-deploy-playstore.yml'
  workflow_dispatch:
    inputs:
      release_notes:
        description: "What's new in this release? (shown to testers, max 500 chars)"
        required: true

env:
  JAVA_VERSION: '17'

permissions:
  contents: write   # needed to create GitHub releases

jobs:
  build-and-deploy:
    name: Build AAB & Deploy to Internal Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: âœ… Validate release notes
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          NOTES="${{ github.event.inputs.release_notes }}"
        else
          # Push trigger: only require whatsnew update when Android source files changed
          ANDROID_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -c "^android/" || true)
          if [ "$ANDROID_CHANGED" -gt 0 ]; then
            if ! git diff --name-only HEAD~1 HEAD | grep -q "distribution/whatsnew/"; then
              echo "âŒ Release notes not updated for this release."
              echo "   Update distribution/whatsnew/whatsnew-en-IN with what changed before merging to main."
              exit 1
            fi
          fi
          NOTES=$(cat distribution/whatsnew/whatsnew-en-IN 2>/dev/null || echo "")
        fi

        TRIMMED=$(echo "$NOTES" | tr -d '[:space:]')
        if [ -z "$TRIMMED" ]; then
          echo "âŒ Release notes are empty."
          exit 1
        fi
        if [ ${#NOTES} -lt 10 ]; then
          echo "âŒ Release notes are too short (min 10 chars). Describe what changed."
          exit 1
        fi
        if echo "$NOTES" | grep -qi "bug fixes and performance improvements"; then
          echo "âŒ Release notes still contain the default placeholder. Write real notes."
          exit 1
        fi
        echo "âœ… Release notes accepted: $NOTES"

    # â”€â”€ Java â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â˜• Setup Java ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
        cache: 'gradle'

    # â”€â”€ Signing keystore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ”‘ Decode upload keystore
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      run: |
        echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > android/upload-keystore.jks

    - name: ğŸ“ Create key.properties
      env:
        STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
      run: |
        cat > android/key.properties << EOF
        storePassword=$STORE_PASSWORD
        keyPassword=$KEY_PASSWORD
        keyAlias=$KEY_ALIAS
        storeFile=../upload-keystore.jks
        EOF
      # storeFile is resolved relative to android/app/, so ../upload-keystore.jks â†’ android/upload-keystore.jks

    # â”€â”€ Supabase config injected at compile time via local.properties â”€â”€
    - name: ğŸ“ Inject build properties
      env:
        SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        PROMO_CODE_PRO_HASH: ${{ secrets.PROMO_CODE_PRO_HASH }}
        PROMO_CODE_PRO_EXPIRY: ${{ secrets.PROMO_CODE_PRO_EXPIRY }}
      run: |
        cat >> android/local.properties << EOF
        SUPABASE_URL=https://$SUPABASE_PROJECT_REF.supabase.co
        SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY
        PROMO_CODE_PRO_HASH=$PROMO_CODE_PRO_HASH
        PROMO_CODE_PRO_EXPIRY=$PROMO_CODE_PRO_EXPIRY
        EOF

    # â”€â”€ Build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ”¨ Build release AAB
      working-directory: ./android
      run: |
        ./gradlew bundleRelease \
          -PversionCode=${{ github.run_number }} \
          -PversionName=1.1.${{ github.run_number }} \
          --no-daemon \
          --stacktrace
      env:
        GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.parallel=true"

    # â”€â”€ Write release notes (manual dispatch overrides file; push uses committed file) â”€â”€
    - name: ğŸ“ Write release notes
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          NOTES="${{ github.event.inputs.release_notes }}"
          NOTES="${NOTES:0:500}"
          echo "$NOTES" > distribution/whatsnew/whatsnew-en-IN
          echo "$NOTES" > distribution/whatsnew/whatsnew-en-US
        fi
        # For push: whatsnew files are already committed in the repo â€” nothing to write

    # â”€â”€ Play Store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ”‘ Write Play Store service account
      env:
        PLAY_STORE_SERVICE_ACCOUNT_JSON: ${{ secrets.PLAY_STORE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "$PLAY_STORE_SERVICE_ACCOUNT_JSON" > play-store-service-account.json

    - name: ğŸš€ Upload to Play Store Internal Testing
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJson: play-store-service-account.json
        packageName: com.fenn.callshield
        releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
        track: internal
        status: completed
        whatsNewDirectory: distribution/whatsnew
        mappingFile: android/app/build/outputs/mapping/release/mapping.txt
        debugSymbols: android/app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib

    # â”€â”€ Cleanup sensitive files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ§¹ Security cleanup
      if: always()
      run: |
        rm -f android/upload-keystore.jks
        rm -f android/key.properties
        rm -f play-store-service-account.json
        # Strip injected secrets from local.properties (keep sdk.dir only)
        grep -E "^sdk\.dir=" android/local.properties > /tmp/lp.tmp || true
        mv /tmp/lp.tmp android/local.properties

    # â”€â”€ Artifacts & Release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¦ Upload AAB as workflow artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: callshield-aab-${{ github.run_number }}
        path: android/app/build/outputs/bundle/release/app-release.aab
        retention-days: 90

    - name: ğŸ·ï¸ Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: v1.1.${{ github.run_number }}-beta
        name: Beta v1.1.${{ github.run_number }}
        prerelease: true
        body: |
          ## ğŸ›¡ï¸ CallShield Beta v1.1.${{ github.run_number }}

          **Track:** Internal Testing (Play Store)

          ### What's New
          ${{ github.event.inputs.release_notes || 'See distribution/whatsnew/whatsnew-en-IN' }}

          ### Build Details
          - **Version code:** ${{ github.run_number }}
          - **Commit:** ${{ github.sha }}
          - **Author:** ${{ github.event.head_commit.author.name }}
          - **Message:** ${{ github.event.head_commit.message }}

          ---
          ğŸ“± Available to internal testers via Play Store
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
