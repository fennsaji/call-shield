name: CI â€” Pull Request Checks

on:
  pull_request:
    branches: [main, dev]

concurrency:
  # Cancel in-progress CI runs for the same PR when new commits are pushed
  group: ci-pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Detect which parts of the repo actually changed so we skip irrelevant
  # jobs (e.g. don't run Android tests on a backend-only PR).
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  changes:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      android: ${{ steps.filter.outputs.android }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          android:
            - 'android/**'
          backend:
            - 'supabase/**'

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ANDROID: lint + unit tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  android-ci:
    name: Android â€” Lint & Unit Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.android == 'true'
    timeout-minutes: 20

    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v4

    - name: â˜• Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        cache: 'gradle'

    # Provide stub values so BuildConfig fields compile â€” no real secrets needed for CI checks
    - name: ğŸ“ Create stub local.properties
      run: |
        cat > android/local.properties << EOF
        sdk.dir=$ANDROID_HOME
        SUPABASE_URL=https://stub.supabase.co
        SUPABASE_ANON_KEY=stub_anon_key
        EOF

    - name: ğŸ” Run Android Lint
      working-directory: ./android
      run: ./gradlew lintDebug --no-daemon
      env:
        GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx3g"

    - name: ğŸ§ª Run Unit Tests
      working-directory: ./android
      run: ./gradlew testDebugUnitTest --no-daemon
      env:
        GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx3g"

    - name: ğŸ“Š Upload lint report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: android-lint-report-${{ github.event.pull_request.number }}
        path: android/app/build/reports/lint-results-debug.html
        retention-days: 14

    - name: ğŸ“Š Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: android-test-results-${{ github.event.pull_request.number }}
        path: android/app/build/reports/tests/testDebugUnitTest/
        retention-days: 14

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # BACKEND: TypeScript type check + Deno tests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  backend-ci:
    name: Backend â€” Type Check & Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    timeout-minutes: 10

    steps:
    - name: ğŸ”„ Checkout
      uses: actions/checkout@v4

    - name: ğŸ¦• Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: v2.x

    - name: ğŸ” TypeScript type check â€” all Edge Functions
      working-directory: ./supabase/functions
      run: |
        echo "Checking TypeScript across all Edge Functions..."
        find . -name "*.ts" -type f | while read -r file; do
          echo "  â†’ $file"
          deno check "$file" || { echo "âŒ Type error in $file"; exit 1; }
        done
        echo "âœ… All TypeScript files passed"

    - name: ğŸ”’ Security scan
      working-directory: ./supabase/functions
      run: |
        if grep -rn "console\.log.*password\|console\.log.*secret\|console\.log.*key" . 2>/dev/null; then
          echo "âŒ Potential credential logging found"
          exit 1
        fi
        echo "âœ… No credential logging found"

    - name: ğŸ§ª Run Deno tests
      working-directory: ./supabase/functions
      run: |
        # Run any *.test.ts files found under functions/
        TEST_FILES=$(find . -name "*.test.ts" -type f)
        if [ -z "$TEST_FILES" ]; then
          echo "â„¹ï¸  No test files found â€” skipping"
          exit 0
        fi
        echo "Running tests..."
        deno test --allow-env --allow-net $TEST_FILES
        echo "âœ… All tests passed"

    - name: ğŸ§ª Validate Edge Function structure
      working-directory: ./supabase/functions
      run: |
        for func_dir in */; do
          func_name=$(basename "$func_dir")
          [ "$func_name" = "_shared" ] && continue
          if [ ! -f "${func_dir}index.ts" ]; then
            echo "âŒ Missing index.ts in: $func_name"
            exit 1
          fi
          if ! grep -q "Deno.serve" "${func_dir}index.ts"; then
            echo "âš ï¸  $func_name: Deno.serve pattern not found"
          fi
          echo "âœ… $func_name"
        done

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Gate â€” this job always runs and summarises pass/fail for branch
  # protection rules. Configure branch protection to require "CI Gate".
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ci-gate:
    name: CI Gate
    runs-on: ubuntu-latest
    needs: [android-ci, backend-ci]
    # Run even when upstream jobs were skipped (path filter didn't match)
    if: always()
    steps:
    - name: âœ… Check CI results
      run: |
        ANDROID="${{ needs.android-ci.result }}"
        BACKEND="${{ needs.backend-ci.result }}"

        echo "Android CI : $ANDROID"
        echo "Backend CI : $BACKEND"

        # 'skipped' means the path filter didn't match â€” that's fine
        for result in "$ANDROID" "$BACKEND"; do
          if [ "$result" = "failure" ] || [ "$result" = "cancelled" ]; then
            echo "âŒ CI failed"
            exit 1
          fi
        done

        echo "âœ… All required checks passed"
