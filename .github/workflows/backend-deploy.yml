name: Backend Production Deployment

on:
  push:
    branches: [main]
    paths:
      - 'supabase/**'
      - '.github/workflows/backend-deploy.yml'
  workflow_dispatch:
    inputs:
      deploy_functions:
        description: 'Deploy Edge Functions'
        required: false
        default: true
        type: boolean
      deploy_migrations:
        description: 'Deploy Database Migrations'
        required: false
        default: true
        type: boolean

concurrency:
  group: backend-deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1 â€” Validate TypeScript + structure before any deployment
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  validate-backend:
    name: Validate Backend Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ¦• Setup Deno
      uses: denoland/setup-deno@v2
      with:
        deno-version: v2.x   # Track latest Deno 2 minor

    - name: ğŸ” TypeScript compilation check
      working-directory: ./supabase/functions
      run: |
        echo "ğŸ” Checking TypeScript for all Edge Functions..."
        find . -name "*.ts" -type f | while read -r file; do
          echo "  Checking: $file"
          deno check "$file" || { echo "âŒ TypeScript error in $file"; exit 1; }
        done
        echo "âœ… All TypeScript files are valid"

    - name: ğŸ§ª Validate Edge Function structure
      working-directory: ./supabase/functions
      run: |
        echo "ğŸ” Validating Edge Function structure..."
        for func_dir in */; do
          func_name=$(basename "$func_dir")
          # _shared contains utilities, not deployable functions
          if [ "$func_name" = "_shared" ]; then
            echo "â„¹ï¸  Skipping _shared (utility code)"
            continue
          fi
          if [ ! -f "${func_dir}index.ts" ]; then
            echo "âŒ Missing index.ts in function: $func_name"
            exit 1
          fi
          if ! grep -q "Deno.serve" "${func_dir}index.ts"; then
            echo "âš ï¸  $func_name may not follow Deno.serve pattern"
          fi
          echo "âœ… $func_name structure valid"
        done

    - name: ğŸ”’ Security scan
      working-directory: ./supabase/functions
      run: |
        echo "ğŸ”’ Running security checks..."
        # Flag any accidental credential logging
        if grep -rn "console\.log.*password\|console\.log.*secret\|console\.log.*key" . 2>/dev/null; then
          echo "âŒ Potential credential logging found â€” aborting"
          exit 1
        fi
        # Warn on localhost refs (expected in dev, suspicious in prod code)
        if grep -rn "localhost\|127\.0\.0\.1" . 2>/dev/null; then
          echo "âš ï¸  Found localhost references (verify these are not in production paths)"
        fi
        echo "âœ… Security scan passed"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2 â€” Deploy migrations + functions + secrets
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-to-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate-backend
    timeout-minutes: 15
    environment: production

    outputs:
      project_ref: ${{ steps.env-setup.outputs.project_ref }}

    steps:
    - name: ğŸ”„ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Install Supabase CLI
      run: |
        SUPABASE_VERSION="2.33.9"
        curl -fsSL \
          "https://github.com/supabase/cli/releases/download/v${SUPABASE_VERSION}/supabase_linux_amd64.tar.gz" \
          | tar -xz -C /tmp
        sudo mv /tmp/supabase /usr/local/bin/supabase
        supabase --version

    - name: ğŸ” Setup environment
      id: env-setup
      run: |
        echo "project_ref=${SUPABASE_PROJECT_REF}" >> $GITHUB_OUTPUT
        echo "PROJECT_REF=${SUPABASE_PROJECT_REF}" >> $GITHUB_ENV
        echo "ğŸ“ Project ref: ${SUPABASE_PROJECT_REF}"
      env:
        SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}

    - name: âœ… Validate Supabase connection
      run: |
        if [ -z "$PROJECT_REF" ]; then
          echo "âŒ SUPABASE_PROJECT_REF secret is not set"
          exit 1
        fi
        supabase projects list > /dev/null
        echo "âœ… Supabase connection successful"
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

    - name: ğŸ”— Link project & push migrations
      if: ${{ github.event.inputs.deploy_migrations != 'false' }}
      working-directory: ./supabase
      run: |
        echo "ğŸ”— Linking to project $PROJECT_REF..."
        supabase link --project-ref "$PROJECT_REF"

        echo "ğŸ“¦ Pushing DB migrations..."
        supabase db push --include-all

        echo "âœ… Migrations applied successfully"
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        PROJECT_REF: ${{ env.PROJECT_REF }}

    - name: ğŸ“¦ Deploy Edge Functions
      if: ${{ github.event.inputs.deploy_functions != 'false' }}
      working-directory: ./supabase
      run: |
        echo "ğŸš€ Deploying Edge Functions..."
        # --no-verify-jwt: device-token auth is enforced inside each function,
        # not at the JWT layer (no user accounts in CallShield)
        supabase functions deploy --no-verify-jwt --project-ref "$PROJECT_REF"
        echo "âœ… Edge Functions deployed"
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        PROJECT_REF: ${{ env.PROJECT_REF }}

    - name: ğŸ”‘ Update Function Secrets
      working-directory: ./supabase
      run: |
        echo "ğŸ”‘ Pushing Edge Function secrets..."
        # Write a minimal secrets file â€” only what CallShield functions need
        cat > .env.production << 'EOF'
        SUPABASE_URL=https://${{ env.PROJECT_REF }}.supabase.co
        SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        GOOGLE_SERVICE_ACCOUNT_KEY=${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
        EOF

        supabase secrets set \
          --env-file .env.production \
          --project-ref "$PROJECT_REF"

        rm -f .env.production
        echo "âœ… Secrets updated"
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        PROJECT_REF: ${{ env.PROJECT_REF }}

    - name: ğŸ§ª Smoke test production deployment
      run: |
        BASE="https://$PROJECT_REF.supabase.co"
        echo "ğŸ§ª Smoke-testing $BASE ..."

        # REST API health
        if curl -fsS "$BASE/rest/v1/" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" > /dev/null; then
          echo "âœ… REST API healthy"
        else
          echo "âš ï¸  REST API check failed"
        fi

        # Each Edge Function should return something (even 401/422 means it's alive)
        FUNCTIONS=(report reputation correct seed-db-manifest verify-subscription)
        for func in "${FUNCTIONS[@]}"; do
          STATUS=$(curl -o /dev/null -w "%{http_code}" -fsS \
            "$BASE/functions/v1/$func" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" || true)
          if [ "$STATUS" != "000" ]; then
            echo "âœ… $func is responding (HTTP $STATUS)"
          else
            echo "âš ï¸  $func did not respond"
          fi
        done

        echo "ğŸ‰ Smoke tests complete"
      env:
        PROJECT_REF: ${{ env.PROJECT_REF }}

    - name: ğŸ“Š Deployment summary
      run: |
        echo ""
        echo "ğŸ‰ CallShield backend deployed to production!"
        echo "ğŸŒ API:       https://$PROJECT_REF.supabase.co"
        echo "ğŸ“‹ Components deployed:"
        echo "   â€¢ DB Migrations : ${{ github.event.inputs.deploy_migrations != 'false' && 'âœ…' || 'â­ï¸ skipped' }}"
        echo "   â€¢ Edge Functions: ${{ github.event.inputs.deploy_functions != 'false' && 'âœ…' || 'â­ï¸ skipped' }}"
        echo "   â€¢ Secrets       : âœ…"
      env:
        PROJECT_REF: ${{ env.PROJECT_REF }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3 â€” Final status notification
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [validate-backend, deploy-to-production]
    if: always()

    steps:
    - name: ğŸ“¢ Report result
      run: |
        if [ "${{ needs.deploy-to-production.result }}" = "success" ]; then
          echo "ğŸ‰ CallShield backend deployment succeeded!"
          echo "ğŸŒ Production API is live"
        else
          echo "âŒ CallShield backend deployment failed â€” check logs above"
          exit 1
        fi
